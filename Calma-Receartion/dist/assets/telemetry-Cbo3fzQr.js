function h(l,e=!1){return e}function c(){return{VITE_API_BASE_URL:void 0,VITE_TELEMETRY_ENABLED:h(void 0,!1)}}class u{sessionId;pageId;eventQueue=[];isEnabled=c().VITE_TELEMETRY_ENABLED??!0;batchSize=10;flushInterval=5e3;hoverStartTimes=new Map;scrollMetrics={lastScrollY:0,lastScrollTime:0,maxScrollDepth:0};constructor(){this.sessionId=this.generateSessionId(),this.pageId=this.generatePageId(),this.initializeEventListeners(),this.startBatchFlush()}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}generatePageId(){return`page_${window.location.pathname.replace(/\//g,"_")}_${Date.now()}`}getViewport(){return{w:window.innerWidth,h:window.innerHeight}}getNormalizedCoordinates(e,t){const r=this.getViewport();return{x_norm:Math.round(e/r.w*100)/100,y_norm:Math.round(t/r.h*100)/100}}getElementSelector(e){if(e.id)return`#${e.id}`;if(e.className){const t=e.className.split(" ").filter(r=>r.length>0);if(t.length>0)return`.${t[0]}`}return e.tagName.toLowerCase()}createBaseEvent(){return{timestamp:new Date().toISOString(),session_id:this.sessionId,page_id:this.pageId,user_agent:navigator.userAgent,viewport:this.getViewport()}}trackClick(e){if(!this.isEnabled)return;const t=e.target,r=this.getNormalizedCoordinates(e.clientX,e.clientY),n={...this.createBaseEvent(),event_type:"click",selector:this.getElementSelector(t),x_norm:r.x_norm,y_norm:r.y_norm,element_text:t.textContent?.slice(0,50)||"",element_type:t.tagName.toLowerCase()};this.addEvent(n)}trackHoverStart(e){if(!this.isEnabled)return;const t=e.target,r=this.getElementSelector(t);this.hoverStartTimes.set(r,Date.now())}trackHoverEnd(e){if(!this.isEnabled)return;const t=e.target,r=this.getElementSelector(t),n=this.hoverStartTimes.get(r);if(n){const i=Date.now()-n,a=this.getNormalizedCoordinates(e.clientX,e.clientY),o={...this.createBaseEvent(),event_type:"hover",selector:r,duration_ms:i,x_norm:a.x_norm,y_norm:a.y_norm};this.addEvent(o),this.hoverStartTimes.delete(r)}}trackScroll(){if(!this.isEnabled)return;const e=window.scrollY,t=Date.now(),r=document.documentElement.scrollHeight-window.innerHeight,n=Math.round(e/r*100);this.scrollMetrics.maxScrollDepth=Math.max(this.scrollMetrics.maxScrollDepth,n);const i=t-this.scrollMetrics.lastScrollTime,a=Math.abs(e-this.scrollMetrics.lastScrollY),o=i>0?a/i*1e3:0,d={...this.createBaseEvent(),event_type:"scroll",scroll_depth:n,scroll_direction:e>this.scrollMetrics.lastScrollY?"down":"up",scroll_speed:Math.round(o)};this.addEvent(d),this.scrollMetrics.lastScrollY=e,this.scrollMetrics.lastScrollTime=t}trackInput(e,t,r,n){if(!this.isEnabled)return;const i={...this.createBaseEvent(),event_type:"input",field_name:e,field_type:t,interaction_time_ms:r,value_length:n};this.addEvent(i)}trackPerformance(e,t,r){if(!this.isEnabled)return;const n={...this.createBaseEvent(),event_type:"performance",metric_name:e,metric_value:t,metric_unit:r};this.addEvent(n)}trackError(e,t,r,n){const i={...this.createBaseEvent(),event_type:"error",error_type:e,error_message:t,stack_trace:r,component_name:n};this.addEvent(i)}addEvent(e){this.eventQueue.push(e),this.eventQueue.length>=this.batchSize&&this.flushEvents()}async flushEvents(){if(this.eventQueue.length===0)return;const e=[...this.eventQueue];this.eventQueue=[];try{if(!this.isEnabled)return;const{VITE_API_BASE_URL:t}=c(),n=`${t||""}/api/telemetry/ingest`,i=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({events:e})});if(!i.ok){const a=JSON.parse(localStorage.getItem("telemetry_events")||"[]");throw a.push(...e),localStorage.setItem("telemetry_events",JSON.stringify(a.slice(-1e3))),new Error(`Telemetry transport failed: ${i.status}`)}}catch{this.eventQueue.unshift(...e)}}startBatchFlush(){setInterval(()=>{this.flushEvents()},this.flushInterval)}initializeEventListeners(){document.addEventListener("click",t=>this.trackClick(t),{passive:!0}),document.addEventListener("mouseenter",t=>this.trackHoverStart(t),{capture:!0,passive:!0}),document.addEventListener("mouseleave",t=>this.trackHoverEnd(t),{capture:!0,passive:!0});let e;document.addEventListener("scroll",()=>{clearTimeout(e),e=window.setTimeout(()=>this.trackScroll(),100)},{passive:!0}),window.addEventListener("load",()=>{setTimeout(()=>{const t=performance.getEntriesByType("navigation")[0];t&&(this.trackPerformance("page_load_time",t.loadEventEnd-t.fetchStart,"ms"),this.trackPerformance("dom_content_loaded",t.domContentLoadedEventEnd-t.fetchStart,"ms"))},0)}),window.addEventListener("error",t=>{this.trackError("javascript_error",t.message,t.error?.stack,"global")}),window.addEventListener("unhandledrejection",t=>{this.trackError("promise_rejection",t.reason?.toString()||"Unknown promise rejection",void 0,"global")})}enable(){this.isEnabled=!0}disable(){this.isEnabled=!1}isTrackingEnabled(){return this.isEnabled}getTelemetryData(){const e=localStorage.getItem("telemetry_events");return e?JSON.parse(e):[]}clearTelemetryData(){localStorage.removeItem("telemetry_events"),this.eventQueue=[]}}const s=new u,m=()=>({trackClick:s.trackClick.bind(s),trackInput:s.trackInput.bind(s),trackPerformance:s.trackPerformance.bind(s),trackError:s.trackError.bind(s),isEnabled:s.isTrackingEnabled(),getTelemetryData:s.getTelemetryData.bind(s),clearData:s.clearTelemetryData.bind(s)});export{m as u};
